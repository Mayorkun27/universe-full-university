<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Registration</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../offlines/bootstrap.min.css">
    <link rel="icon" href="../images/single.png">
    <link rel="stylesheet" href="../offlines/tabler-icons/webfont/tabler-icons.min.css">
    <link rel="stylesheet" href="../offlines/fontawesome-free-6.4.2-web/css/all.css">

    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="../responsiveness.css">
     <link rel="stylesheet" href="loading.css">
     <style>
          input[type="checkbox"]:disabled{
               background-color: #000 !important;
               opacity: 30%;
          }
          input[type="radio"]:disabled{
               background-color: #000 !important;
               opacity: 30%;
          }
          .decidess{
               display: grid;
               grid-template-columns: repeat(5, 1fr);
          }
          .decidess .gap-3 {
               gap: 0.5rem !important;
           }
          @media (min-width:200px) and (max-width:991px) {
               .decidess{
                    display: grid!important;
                    grid-template-columns: repeat(2, 1fr)!important;
               }
          }
     </style>
</head>
<body style="position: relative;"  class="collapsed">
       <!-- Loading display -->
     <div id="loading" class="loading">
          <div class="loader">
               <p class="text">
                    Universe<br>University
               </p>
          </div>
     </div>

     <main id="content" class="hidden row general justify-content-between">

        <div class="col-2 p-0" id="side">
            <nav class="sidebar">
                <div class="sidebar-top-wrapper">
                        <div class="sidebar-top mx-auto">
                        <a href="#" class="logo_wrapper">
                            <img src="../images/multiple.png" alt="logo" class="logo-small logo-small1">
                            <img src="../images/single.png" alt="logo" class="logo-small logo-small2">
                        </a>
                        </div>
                        <button class="expand-btn" type="button"><i class="fa fa-expand"></i></button>
                </div>
                <div class="sidebar-links-wrapper">
                        <div class="sidebar-links">
                            <ul>
                                <li>
                                    <a href="index" class="main-item" title="Dashboard">
                                            <i class="fa-solid fa-tachograph-digital"></i>
                                            <span class="link hide">Dashboard</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="profile" title="Profile" class="main-item">
                                            <i class="fa-solid fa-building-columns"></i>
                                            <span class="link hide">Profile</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="#" title="Course Registration" class="main-item active">
                                            <i class="fa fa-clipboard"></i>
                                            <span class="link hide">Course Registration</span>
                                    </a>
                                </li>
                                <li>
                                     <a href="deposit" title="Tution Fee" class="main-item">
                                          <i class="fa fa-money-bill-wave"></i>
                                          <span class="link hide">Tution Fee</span>
                                     </a>
                                </li>
                                <li>
                                     <a href="transactionHistory" title="Transactions History" class="main-item">
                                          <i class="fa fa-exchange"></i>
                                          <span class="link hide">Transactions History</span>
                                     </a>
                                </li>
                            </ul>
                        </div>
                </div>
                <div class="sidebar_bottom">
                        <div class="sidebar_profile">
                            <div class="avatar_wrapper">
                                <img src="../images/img12.png" alt="avatar" class="avatar">
                            </div>
                            <div class="avatar_name hide">
                                <div class="user-name"> </div>
                                <div class="email"></div>
                            </div>
                        </div>
                        <!-- Logout icon -->
                        <a title="Logout" class="logout tooltips main-item" onclick="logout()">
                            <i class="fa fa-sign-out-alt"></i>
                            <span class="expand-icon">Logout</span>
                        </a>
                </div>
            </nav>
        </div>

        <div class="col-10 p-0" id="main">
            <section class="main-content ms-auto pb-5">
                <div class="row align-items-center">
                    <div class="col-12">
                        <div class="in-new-prod-cont p-3">
                            <h4 class="p-0 m-0">Course Registration</h4>
                        </div>
                    </div>
                    <div class="col-lg-6 my-3 ms-auto">
                        <div class="card profile p-3">
                            <div class="profile-text">
                                <p><span class="fw-bold">NAME: </span><span id="fullName"></span></p>
                                <p><span class="fw-bold">MATRIC NUMBER: </span><span id="matricNo"></span></p>
                                <p><span class="fw-bold">EMAIL: </span><span id="email"></span></p>
                            </div>
                            <div class="profile-img rounded rounded-3">
                                <img src="" alt="..." class="img-fluid" id="image">
                            </div>
                        </div>
                    </div>
                    <div class="col-12 my-3">
                        <form class="row" id="courseRegistrationForm">
                            <div class="col-12 forms mx-auto w-100 row">
                                <div class="inputs my-4 decidess">
                                    <!-- This will be dynamically filled by JavaScript -->
                                </div>                              
                                <!-- Courses will be displayed dynamically here -->
                            </div>
                            <div class="col-12 text-center mt-3">
                                <button class="btn herobtn mx-auto" type="submit">Register Courses</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <footer class="footer text-center py-2 my-4 rounded">
                    <p class="fs-5 mb-0" style="opacity: 30%;">Copyright &copy; 2024 Universe University Student Portal. All rights reserved.</p>
                </footer>
            </section>


            <div id="alerting"></div>
        </div>

     </main>


    <script src="loading.js"></script>
    <script src="sidebar.js"></script>
    <!-- Bootstrap  -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script src="bootstrap-5.3.3-dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awsome -->
    <script src="https://kit.fontawesome.com/2a49fbdbb8.js" crossorigin="anonymous"></script>
    <!-- Lottie Player -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="dashboard.js"></script>
    <script>
     let alerting = document.querySelector('#alerting');

        document.addEventListener("DOMContentLoaded", async function () {
            let studyType = '';
        
            try {
                // Get userId from local storage and save to variable
                const userId = localStorage.getItem('userId');
                const apiUrl = `/api/v1/auth/users/${userId}`;
        
                const token = localStorage.getItem("token"); // Retrieve token from localStorage
        
                if (!token || token.split('.').length !== 3) {
                    console.error("Invalid Token Format");
                    // Handle invalid token (e.g., redirect to login page)
                } else {
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
        
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
        
                    const data = await response.json();
                    console.log(data.user);
                    user = data.user;
                    studyType = data.user.studyType;
                    console.log(studyType);
   
                       let userName = user["firstName"] + " " + user["lastName"];
                       let userMatric = user["matricNumber"];
                       let userEmail = user["email"];
                       let userImage = user["photo"];
   
                       document.querySelector("#fullName").innerHTML = userName;
                       document.querySelector("#matricNo").innerHTML = userMatric;
                       document.querySelector("#email").innerHTML = userEmail;
                       document.querySelector("#image").src = userImage;
        
                    // Fetch faculties and their courses
                    const facultiesResponse = await axios.get("/api/v1/faculty/allfaculty");
                    console.log(facultiesResponse.data.data);
        
                    const faculties = facultiesResponse.data.data;
                    const studentFaculty = faculties.find(faculty => faculty.name === studyType);
        
                    if (studentFaculty) {
                        console.log('Student Faculty:', studentFaculty);
        
                        // Fetch existing registrations for the user
                        const registrationsResponse = await axios.get(`/api/v1/courseRegistration/get/${userId}`);
                        const existingRegistrations = registrationsResponse.data.courseRegistrations || [];
                        console.log('Existing Registrations:', existingRegistrations);
        
                        displayRadioButtons(studentFaculty, existingRegistrations); // Pass existing registrations to displayRadioButtons function
                    } else {
                        console.error("No matching faculty found for the student.");
                    }
                }
            } catch (error) {
                console.error('Fetch error:', error);
            }
        });
        
        const inputsContainer = document.querySelector('.decidess');
        inputsContainer.addEventListener('change', function (event) {
            const selectedYear = event.target.value;
            axios.get(`/api/v1/transaction/get/${getUserId()}`)
                .then(function (response) {
                    const transactions = response.data.transactions;
                    const groupedTransactions = transactions.reduce((acc, transaction) => {
                        if (!acc[transaction.year]) {
                            acc[transaction.year] = [];
                        }
                        acc[transaction.year].push(transaction);
                        return acc;
                    }, {});
        
                    if (groupedTransactions[selectedYear]) {
                        const selectedYearTransactions = groupedTransactions[selectedYear];
                        const transTypeCount = selectedYearTransactions.reduce((acc, transaction) => {
                            acc[transaction.transType] = (acc[transaction.transType] || 0) + 1;
                            return acc;
                        }, {});
        
                        for (const [transType, count] of Object.entries(transTypeCount)) {
                            console.log(transType, count)
                            if (transType == 'Full Payment' && count >= 1) {
                                document.querySelectorAll('#course').forEach(i => {
                                    i.disabled = false;
                                })
                            } else if (transType == 'Part Payment' && count == 2) {
                                document.querySelectorAll('#course').forEach(i => {
                                    i.disabled = false;
                                })
                            } else if (transType == 'Part Payment' && count == 1) {
                                document.querySelectorAll('#course').forEach(i => {
                                    i.disabled = true;
                                })
                            } else {
                                document.querySelectorAll('#course').forEach(i => {
                                    i.disabled = true;
                                })
                            }
                        }
                    } else {
                        document.querySelectorAll('#course').forEach(i => {
                            i.disabled = true;
                        })
                        console.log('No transactions found for the selected year:', selectedYear);
                    }
                })
                .catch(function (error) {
                    console.error("Error fetching transactions:", error);
                });
        
            console.log('Selected year:', selectedYear);
        });
        
        // Define getUserId function to retrieve user ID
        function getUserId() {
            // Example: retrieve user ID from localStorage
            return localStorage.getItem('userId');
        }
        
        function displayRadioButtons(studentFaculty, existingRegistrations) {
            const years = Object.keys(studentFaculty.courses); // Get all years available in the student's faculty
        
            const inputsContainer = document.querySelector('.decidess');
            years.forEach(year => {
                const isYearRegistered = existingRegistrations.some(reg => reg.year === year);
                console.log(isYearRegistered);
                const yearHtml = `
                    <div class="d-flex align-items-center gap-3">
                        <input type="radio" name="payment" id="${year}" value="${year}" ${isYearRegistered ? 'disabled' : ''}>
                        <label for="${year}">${year}</label>
                    </div>
                `;
                inputsContainer.insertAdjacentHTML('beforeend', yearHtml);
            });
        
            // Initialize the form with courses of the first year as an example
            if (years.length > 0) {
                displayCourses(studentFaculty.courses[years[0]], existingRegistrations);
            }
        
            // Add event listener to radio buttons to display courses on change
            inputsContainer.addEventListener('change', function (event) {
                const selectedYear = event.target.value;
                displayCourses(studentFaculty.courses[selectedYear], existingRegistrations);
            });
        }
        
        function displayCourses(courses, existingRegistrations) {
            const coursesContainer = document.querySelector('.forms.row');
        
            courses.forEach(course => {
                const isRegistered = existingRegistrations.some(reg => reg.course === course); // Check if the course is already registered
                const courseHtml = `
                    <div class="col-lg-6 my-3">
                        <div class="d-flex gap-3 courses justify-content-between w-100 align-items-center">
                            <label for="productName">${course}</label>
                            <input type="checkbox" class="pick" name="course" id="course" value="${course}" disabled>
                        </div>
                    </div>
                `;
                coursesContainer.insertAdjacentHTML('beforeend', courseHtml);
            });
        }
        
        // Assuming this is inside a <script> tag in courseregistration.html
        document.getElementById('courseRegistrationForm').addEventListener('submit', async function (event) {
            event.preventDefault();
        
            const userId = localStorage.getItem('userId');
            const selectedYearRadio = document.querySelector('input[name="payment"]:checked');
            const selectedYear = selectedYearRadio ? selectedYearRadio.value : null;
            const selectedCourses = Array.from(document.querySelectorAll('input[name="course"]:checked')).map(el => el.value);
        
            const payload = {
                userId: userId,
                year: selectedYear,
                courses: selectedCourses
            };
        
            try {
                const response = await fetch('/api/v1/courseRegistration/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
        
                if (!response.ok) {
                    throw new Error('Failed to register courses');
                }
        
                console.log('Courses registered successfully');
                alerting.innerHTML = `
                    <div class="alert alert-success d-flex gap-2 align-items-center" role="alert">
                         <i class="ti ti-check fa-2x"></i>
                         <div>Courses registered successfully</div>
                    </div>`;
                    setTimeout(() => {
                         alerting.innerHTML = "";
                    }, 5000);

            } catch (error) {
                console.error('Error registering courses:', error.message);
                alerting.innerHTML = `
               <div class="alert alert-danger d-flex gap-2 align-items-center" role="alert">
                    <i class="ti ti-mood-wrrr fa-2x"></i>
                    <div>Error registering courses: ${error.message}</div>
               </div>`;
               setTimeout(() => {
                    alerting.innerHTML = "";
               }, 5000); // Clear alert after 5 seconds
            }
        });
    </script>
          
              
 </body>
 </html>